# Getting Started

## Table of Contents

- [Module Creation Workflow](#module-creation-workflow)
- [Module Management](#module-management)
- [Upload and Deployment](#upload-and-deployment)
- [CI/CD Pipeline](#cicd-pipeline)
- [Development Patterns](#development-patterns)
- [Available Tasks](#available-tasks)
- [Troubleshooting](#troubleshooting)

## Prerequisites

- Bazel 8.x or higher
- Git
- VS Code with Bazel extension (recommended)

## Initial Setup

1. **Clone the repository:**
   ```bash
   git clone https://github.com/vectorgrp/bazel-rules.git
   cd bazel-rules
   ```

2. **Verify Bazel setup:**
   ```bash
   bazel --version
   ```

3. **Run validation tasks:**
   ```bash
   bazel run //:buildifier_check
   ```

4. **Explore available modules:**
   ```bash
   ls bcr-modules/modules/
   ```

## Module Creation Workflow

### Creating a New Module

Modules in this repository follow a standardized structure using three core macros:

#### 1. Directory Structure Setup

Create the following structure for a new module:

```
bcr-modules/modules/<module_name>/
├── BUILD.bazel                    # Module definition
├── <module_name>.MODULE.bazel     # Module dependencies
└── <version>/
    └── BUILD.bazel                # Version-specific build
```

#### 2. Module Definition (`BUILD.bazel`)

```bazel
load("//bcr-modules/macros:add_module_macro.bzl", "module_bcr_dir")

package(default_visibility = ["//visibility:public"])

module_bcr_dir(
    name = "my_module",
    homepage = "https://github.com/example/project",
    versions = [
        "1.0.0",
    ],
    visibility = ["//visibility:public"],
)
```

#### 3. Version-specific Configuration (`<version>/BUILD.bazel`)

```bazel
load("//bcr-modules/macros:module_macro.bzl", "module")
load("//bcr-modules/macros:upload_macro.bzl", "module_upload")

package(default_visibility = ["//visibility:public"])

module(
    name = "my_module",
    module_version = "1.0.0",
    srcs = glob(["**/*"]),  # or specific files
    third_party_prefix = "my_module",
    # integrity = "sha256-...",  # Add after first upload
    visibility = ["//visibility:public"],
)

module_upload(
    name = "my_module",
    archive = "my_module",
    upload_module_name = "my_module",
    version = "1.0.0",
    visibility = ["//visibility:public"],
)
```

#### 4. Module Dependencies (`<module_name>.MODULE.bazel`)

```bazel
# Dependencies for my_module
bazel_dep(name = "rules_cc", version = "0.1.1")
# Add other dependencies as needed
```

#### 5. Include in Root MODULE.bazel

Add the include statement to the root `MODULE.bazel`:

```bazel
include("//bcr-modules/modules/my_module:my_module.MODULE.bazel")
```

### Macro Overview

The system uses three primary macros that work together:

- **`module_bcr_dir`** - Creates registry directory structure and metadata
- **`module`** - Handles archive packaging and module file generation
- **`module_upload`** - Manages upload targets for dev/prod environments

### Working with Expanded Macro Targets

**Important:** This repository relies heavily on the **Bazel VS Code extension** to visualize and work with the many targets generated by the macro system. Each macro expands into multiple Bazel targets that handle different aspects of module management.

#### Using the Bazel Extension

1. **Install the Bazel extension** in VS Code for optimal development experience
2. **Open the Bazel Targets view** to see all expanded targets from macros
3. **Navigate expanded targets** to find specific upload, build, and test targets

For example, the `module_upload` macro creates targets like:
- `upload.github_prod_get_archive_override` - Generate archive override config

#### Target Discovery

Without the VS Code extension, you can also discover targets using:

```bash
# List all targets in a module directory
bazel query "//bcr-modules/modules/<module_name>/..."

# Find upload-related targets
bazel query "//bcr-modules/modules/<module_name>/..." | grep upload

# Find test targets
bazel query 'kind(".*_test", "//bcr-modules/modules/<module_name>/...")'
```

## Module Management

### Building Modules

```bash
# Build a module archive
bazel build //bcr-modules/modules/<module_name>/<version>:<module_name>

# Build with production configuration
bazel build //bcr-modules/modules/<module_name>/<version>:<module_name> --config=prod
```

### Adding to Registry

```bash
# Add module to the central registry
# For development/staging URLs (default)
bazel run //bcr-modules/modules/<module_name>:<module_name>.add_to_repo

# For production URLs (after production release)
bazel run --//:BUILD_PROD_MODULES=True //bcr-modules/modules/<module_name>:<module_name>.add_to_repo
```

This command:
- Builds all required archives and metadata files
- Generates `metadata.json`, `source.json`, `MODULE.bazel`, and `BUILD.bazel`
- Copies files to `vector-bazel-central-registry/modules/<module_name>/`
- Automatically overwrites existing files without prompting

> **Note:** Use `--//:BUILD_PROD_MODULES=True` when updating the registry after production releases to ensure production URLs are used in `source.json`.

### Performance Optimization with Integrity Hashes

After successful production upload, update the module with the SHA256 integrity hash:

```bazel
module(
    name = "my_module",
    module_version = "1.0.0",
    integrity = "sha256-AbCdEfGhIjKlMnOpQrStUvWxYz1234567890+/=",  # Add this
    # ... other attributes
)
```

Benefits:
- Skips archive rebuilding during local development
- Reduces CI execution time
- Ensures consistent artifact usage

## Upload and Deployment

### Development Uploads

Uploads to the development/staging environment are handled automatically by the CI/CD pipeline when a Pull Request is merged.

### Production Uploads

Production uploads are triggered manually via the GitHub Actions "Production Release" workflow.

### Archive Override Generation

After upload, get the archive override configuration:

```bash
bazel run //bcr-modules/modules/<module_name>/<version>:upload.github_prod_get_archive_override
```

This generates:
```bazel
archive_override(
    module_name = "my_module",
    integrity = "sha256-...",
    url = "https://...",
)
```

## CI/CD Pipeline

The repository includes a comprehensive GitHub Actions pipeline with multiple stages:

### Pipeline Stages

#### 1. Validation Stage (`validation.yml`)

**Lint Check:**
- Runs `buildifier` to validate Bazel file formatting
- Ensures code style compliance
- Triggers: PR, main branch, tags

**Module Comparison:**
- Compares `bcr-modules/modules/` with `vector-bazel-central-registry/modules/`
- Identifies drift between development and registry
- Uses: `./tools/compare_modules.sh`

**Integrity Check:**
- Lists modules without SHA256 integrity hashes
- Helps identify performance optimization opportunities
- Allows pipeline failure (warning only)

#### 2. Archive Deployment Stage (`staging-release.yml`)

**Staging Archive Upload:**
- Automatically uploads archives for merged PRs to `staging/<module>/<version>` tag
- Uses GitHub Releases

#### 3. Production Release Stage (`production-release.yml`)

**Production Archive Upload:**
- Manually triggered workflow
- Uploads archives to `<module>/<version>` tag
- Uses GitHub Releases

#### 4. Registry Deployment Stage (`registry-update.yml`)

**Registry Update:**
- Updates the central registry with new module metadata
- Commits changes to the `vector-bazel-central-registry` folder

### CI Configuration

Key CI variables are managed via GitHub Secrets and Actions variables.

### CI Best Practices

1. **PR Workflow:**
   - Create feature branch
   - Add/modify modules
   - Create PR to trigger validation
   - Merge PR to trigger staging release

2. **Integrity Hash Management:**
   - Monitor CI warnings for missing integrity hashes
   - Update modules with hashes after successful prod uploads

3. **Registry Synchronization:**
   - Registry updates are automated via CI
   - Manual registry modifications will be overwritten
   - Use `compare_modules` job to identify discrepancies

## Development Patterns

### Common Module Patterns

#### Rules Package Module
```bazel
module(
    name = "rules_custom",
    module_version = "2.1.0", 
    srcs = glob([
        "rules/**/*",
        "lib/**/*", 
        "toolchains/**/*",
    ]),
    additional_dependencies = [
        "rules_cc",
        "bazel_skylib", 
    ],
)
```

### Version Management

- Use semantic versioning: `MAJOR.MINOR.PATCH`
- Create new version directories for each release
- Update the `versions` list in the module's main `BUILD.bazel`
- Consider backward compatibility when updating major versions

### Dependency Management

- Keep module dependencies minimal
- Use `additional_dependencies` in the `module()` macro
- Test dependency resolution: `bazel mod deps`
- Document any version constraints or conflicts

### File Organization

- Place source files logically within the module directory
- Use `third_party_prefix` to organize files in the archive
- Glob patterns are acceptable but be specific when possible
- Include necessary documentation and license files

## Available Tasks

The repository provides several pre-configured Bazel tasks:

### Validation Tasks

```bash
# Lint check and module comparison
bazel run //:buildifier_check && ./tools/compare_modules.sh bcr-modules/modules vector-bazel-central-registry/modules

# List modules needing integrity hashes
bazel query 'kind(source_json, //...) except attr(integrity, "sha256-", //...)' | awk -F ':' '{print $2}' | sed 's/_source\.json//' | sort | uniq
```

### Management Tasks

```bash
# Add module to the central registry
bazel run //bcr-modules/modules/<module_name>:<module_name>.add_to_repo

# Compare module directories
./tools/compare_modules.sh bcr-modules/modules vector-bazel-central-registry/modules
```

## Troubleshooting

### Common Issues

#### Archive Build Failures

**Problem:** Module archive fails to build
```
ERROR: Analysis failed. Could not find files...
```

**Solution:** 
- Verify `srcs` paths are correct
- Check that referenced files exist
- Use `bazel query` to debug target dependencies

#### Registry Synchronization Issues

**Problem:** Module not found in registry after adding

**Solution:**
```bash
# Re-run registry update
bazel run //bcr-modules/modules/<module_name>:<module_name>.add_to_repo

# Check for build errors
bazel build //bcr-modules/modules/<module_name>:<module_name>

# Verify module structure
ls -la vector-bazel-central-registry/modules/<module_name>/
```

#### Performance Issues

**Problem:** Slow builds and long CI times

**Solution:**
- Add integrity hashes to modules after production upload
- Use remote caching (`--remote_cache`)
- Review and minimize unnecessary dependencies

#### Integrity Hash Mismatches

**Problem:** SHA256 mismatch errors

**Solution:**
```bash
# Recalculate hash
sha256sum path/to/archive.tar.gz

# Update module definition
# Remove integrity attribute temporarily if needed
```

### Debug Commands

```bash
# Query module targets
bazel query "//bcr-modules/modules/<module_name>/..."

# Analyze dependencies
bazel mod deps --extension_filter=<module_name>

# Check build configuration
bazel config

# Verbose build output
bazel build --verbose_failures //bcr-modules/modules/<module_name>/...
```

### Getting Help

- Check existing module examples in `bcr-modules/modules/`
- Review CI pipeline logs for detailed error information
- Use `bazel query` and `bazel cquery` for dependency analysis
- Consult the official Bazel documentation for rule development
